# Import the package
library(spartan)
library(XML)
# Folder containing the Netlogo Behaviour Space table,
# and where the processed results will be written to
FILEPATH<-"./LHC"
# Name of the result file generated by Netlogo. Note the sample number
# and CSV is appended to this
LHCSAMPLE_RESULTFILENAME<-"output"
# Number of parameter samples generated from the hypercube
if (Sys.getenv('NUMSAMPLES') != "") {
  NUMSAMPLES<-Sys.getenv('NUMSAMPLES')
} else {
  NUMSAMPLES<-100
}

# Timestep of interest. The behaviour space table is likely to contain
# all timesteps - this narrows the analysis
TIMESTEP<-500
# Parameters of interest in this analysis
PARAMETERS =
  c('commoners-num',
    'number-of-products',
    'initial-projects',
    'num-interest-categories',
    'num-skills',
    'mean-time-required',
    'task-hatch-task-prob',
    'max-find-level',
    'leave-prob',
    'consume-dist',
    'contrib-dist',
    'recommend-dist',
    'find-product-dist',
    'find-project-dist',
    'find-task-dist',
    'prop-project-total-contrib',
    'prop-project-recent-contrib',
    'find-friend',
    'commoner-repulsion-prob',
    'project-repulsion-prob',
    'product-repulsion-prob',
    'product-commoner-attraction-prob',
    'commoner-product-attraction-prob',
    'task-commoner-attraction-prob',
    'commoner-task-attraction-prob',
    'friends-recent-forg',
    'friends-long-forg',
    'consume-recent-forg',
    'consume-long-forg',
    'contrib-recent-forg',
    'contrib-long-forg',
    'project-recent-forg',
    'project-long-forg'
    )
# The simulation output measures being examined. Should be specified
# as they are in the Netlogo file
MEASURES <- c('count commoners', 'count t4sks', 'count projects', 'count products', 'count turtles', 'count commonerprojectlinks', 'count consumerlinks', 'count friendlinks', 'count commonertasklinks', 'count links', 'power-law-alpha', 'sum contrib-distrib')
# What each measure represents. Used in graphing results
MEASURE_SCALE<-c("number of commoners", "number of tasks", "number of projects", "number of products", "number of turtles", "number of commoner-project links", "number of consumer links", "number of friend links", "number of commoner-task links", "number of links", "power law alpha", "numero de contribuciones")
# For each parameter value being analysed, a file is created
# containing the median of each output measure, of each simulation
# run for that value. This sets the file name. No file extension
RESULTFILENAME<-"ParamValResponses.csv"
# Location of a file containing the parameter value sets
# generated by the hypercube sampling (i.e. the file generated
# in the previous method of this tutorial. Unlike above, an
# extension should be specified.
SPARTAN_PARAMETER_FILE<-"LHC_Parameters_for_Runs.csv"
# File name to give to the summary file that is produced showing
# the parameter value sets alongside the median results for each
# simulation output measure. Note no file extension
LHC_ALL_SIM_RESULTS_FILE<-"LHC_Results_file.csv"
# File that summarises all the results - parameters and median simulation
# responses for all parameter value sets
LHCSUMMARYFILENAME<-"LHC_Results_Summary.csv"
# File name to give to the file showing the Partial Rank Correlation
# Coefficients for each parameter. Again note no file extension
CORCOEFFSOUTPUTFILE<-"LHC_corCoeffs.csv"

TIMEPOINTS<-NULL; TIMEPOINTSCALE<-NULL

NETLOGO_SETUPFILE_NAME<-"nl_robustness_setup"


lhc_process_netlogo_result(FILEPATH,LHCSAMPLE_RESULTFILENAME,
	SPARTAN_PARAMETER_FILE,NUMSAMPLES,MEASURES,
	LHC_ALL_SIM_RESULTS_FILE,TIMESTEP)

#PARAMETERS<-table_header_check(PARAMETERS)
#MEASURES<-table_header_check(MEASURES)

lhc_generateLHCSummary(FILEPATH,PARAMETERS,MEASURES,
	LHC_ALL_SIM_RESULTS_FILE,LHCSUMMARYFILENAME,
	SPARTAN_PARAMETER_FILE,TIMEPOINTS,TIMEPOINTSCALE)

lhc_generatePRCoEffs(FILEPATH,PARAMETERS,MEASURES,
	LHCSUMMARYFILENAME,CORCOEFFSOUTPUTFILE,
	TIMEPOINTS,TIMEPOINTSCALE)

lhc_graphMeasuresForParameterChange(FILEPATH,PARAMETERS,
	MEASURES,MEASURE_SCALE,CORCOEFFSOUTPUTFILE,
	LHCSUMMARYFILENAME, c("PDF"), TIMEPOINTS,TIMEPOINTSCALE)

 #oat_process_netlogo_result(FILEPATH,NETLOGO_BEHAVIOURSPACEFILE, PARAMETERS,
 #                          BASELINE, PMIN, PMAX, PINC, MEASURES, RESULTFILENAME,
 #                          ATESTRESULTSFILENAME, TIMESTEP)

                                        # Note that PARAMVALS is set to NULL - we don't use that for Netlogo
  #oat_graphATestsForSampleSize(FILEPATH, PARAMETERS, MEASURES, ATESTSIGLEVEL,
  #                           ATESTRESULTSFILENAME, BASELINE, PMIN, PMAX, PINC, NULL,
  #                           TIMEPOINTS, TIMEPOINTSCALE)
