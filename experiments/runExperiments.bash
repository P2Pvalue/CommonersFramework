#!/bin/bash

## Helpful comments on editing this file, especially if using a mac (thanks to Jesse Abbate for these):
#(1) The "space" in the name of the Netlogo directory (i.e. Netlogo 6.0.1) is an issue. Also, anyone fiddling with a bash script on Mac needs to first disable "smart quotes" because they screw everything up (and you can't "see" the problem from the text editor window). Due to the (mysterious to me) way things work, it means that quotations are needed around commands that contain names with spaces and NOT otherwise.
#(2) The netlogo application folder MUST BE IN THE ROOT APPLICATIONS FOLDER in order for the org.netlogo.headless to work. I had put a copy of it in the folder with my NetLogo Sensitivity Analysis scripts and pointed to it there in the bash script (because I actually use an older version in my main applications folder). So even if you have the .jar file and the lib directory, it won't work unless it's in the main (Macintosh HD or "/" folder) applications folder.


# Path to the headless version of netlogo (a netlogo.jar file):
if [ -z "$PATH_TO_NETLOGO_JAR" ]; then PATH_TO_NETLOGO_JAR="/opt/NetLogo 6.0.4/app/netlogo-6.0.4.jar"; fi

# Path to the headless version of netlogo:
if [ -z "$PATH_TO_NETLOGO_HEADLESS" ]; then PATH_TO_NETLOGO_HEADLESS="/opt/NetLogo 6.0.4/netlogo-headless.sh"; fi

# Path to Netlogo extensions
if [ -z "$PATH_TO_NETLOGO_EXTENSIONS" ]; then PATH_TO_NETLOGO_EXTENSIONS="/opt/NetLogo 6.0.4/app/extensions"; fi

if [ -n "$PATH_TO_NETLOGO" ]; then
    PATH_TO_NETLOGO_JAR=$PATH_TO_NETLOGO/app/netlogo-6.0.4.jar;
    PATH_TO_NETLOGO_HEADLESS=$PATH_TO_NETLOGO/netlogo-headless.sh;
    PATH_TO_NETLOGO_EXTENSIONS=$PATH_TO_NETLOGO/app/extensions;
fi;

# Path to the folders containing the experiment files that were generated by spartan (i.e. the 500 experiment files for an LHC analysis):
PATH_TO_SPARTAN_GENERATED_EXPERIMENT_FILES=./LHC
# Number of parameter samples:
if [ -z "$NUMSAMPLES"]; then NUMSAMPLES=100; fi

# Path to the Netlogo model file (download from the website)
NETLOGO_MODEL_FILE=../CommonersFramework.nlogo

# This script assumes output will be placed in same folders generated by spartan in sampling (so you get result and setup file together)

# Now to run each set:
for ((i=1; i<=NUMSAMPLES; i++));
do
	# Print sample number to screen to check progress
	echo $i

  # fix generated experiments with sed command (a bug populates values in a way netlogo cannot process)
  file=$PATH_TO_SPARTAN_GENERATED_EXPERIMENT_FILES/$i/"lhc_analysis_set$i.xml"
  sed -i -e 's/\(\ value\).*\(=\)/\1\2/' $file

  # Add a final command to stop the R process after the model ends.
  if [ "$(grep -c final $file)" == 0 ]
  then
      sed -i -e "/go\>/a\\
      <final>r:stop</final>" $file
  fi

	# Run Netlogo:
	 "$PATH_TO_NETLOGO_HEADLESS" \
   --model $NETLOGO_MODEL_FILE \
	--setup-file $file \
	--table $PATH_TO_SPARTAN_GENERATED_EXPERIMENT_FILES/$i/"output$i.csv" \
  -DXmx4096m -DXms4096m -DXX:-UseLoopPredicate\

done
